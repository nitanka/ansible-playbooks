---
- name: creating an instance in AWS using default VPC and Security Group 
  hosts: 172.30.1.237
  sudo: yes
  vars: 
    
    instance_info:
      - name: "test server"
        image: "ami-936d9d93" # Ubuntu 14.04
        group_id: 'sg-c495cba1'
        region: 'ap-northeast-1'
        instance_type: 't2.micro'
        key_name: 'nitanka.gogoi'
        vpc_subnet_id: 'subnet-4a07823d'
  tasks: 
    
    - name: Creating the instance
      ec2:
        group_id: 'sg-c495cba1'#"{{ item.group_id }}"
        region: "{{ item.region }}"
        aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
        aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
        image: '{{ item.image }}'
        instance_type: "{{ item.instance_type }}"
        key_name: "{{ item.key_name }}"
        state: present
        assign_public_ip: true
        instance_tags: 
          Name: Project_test
        vpc_subnet_id: 'subnet-4a07823d'
        wait: yes
      register: ec2
      with_items: instance_info
    
    - name: Wait for SSH
      wait_for:
        host: "{{ item['instances'][0]['public_ip'] }}"
        port: 22
        delay: 10
        timeout: 320
        state: started
      with_items: ec2.results
    
    - name: Add hosts group temporary inventory group with pem path
      add_host:
        name: "{{ ec2.results[item.0]['instances'][0]['public_ip'] }}"
        groups: dynamic_hosts
        ansible_ssh_host: "{{ ec2.results[item.0]['instances'][0]['public_ip'] }}"
        ansible_ssh_private_key_file: '/home/ubuntu/nitankagogoi.pem'
        ansible_ssh_user: "ubuntu"
        ec2_vars: "{{ ec2.results[item.0]['instances'][0] }}"
        ec2_instance_ids: "{{ ec2.results[item.0]['instance_ids'] }}"
      with_indexed_items: instance_info
    
- hosts: dynamic_hosts
  name: Install Nginx, MySQL, Java and Add a new user
  sudo: yes
  tasks:
    - include add_user.yml
    - include mysql.yml
    - include nginx.yml
    - include java_install.yml
